{{define "agents-dashboard.html"}}
{{template "layout" .}}
{{end}}

{{define "title"}}Agents Dashboard - Subtrate{{end}}

{{define "head"}}
<style>
    /* Unified styles matching inbox design */
    .dashboard-container {
        background-color: #f5f5f5;
        min-height: calc(100vh - 56px);
    }

    .dashboard-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    }

    .dashboard-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e0e0e0;
    }

    /* Stats card hover effect */
    .stat-card {
        transition: box-shadow 0.15s, transform 0.15s;
    }

    .stat-card:hover {
        box-shadow: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
        transform: translateY(-1px);
    }

    /* Agent card styling */
    .agent-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        transition: box-shadow 0.15s;
    }

    .agent-card:hover {
        box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 2px 6px 2px rgba(60,64,67,.15);
    }

    /* Status indicators */
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-active { background-color: #34a853; }
    .status-busy { background-color: #fbbc05; animation: pulse 2s infinite; }
    .status-idle { background-color: #9aa0a6; }
    .status-offline { background-color: #ea4335; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Progress bar */
    .progress-bar {
        height: 4px;
        background-color: #e8eaed;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }

    .progress-fill.green { background-color: #34a853; }
    .progress-fill.blue { background-color: #1a73e8; }
    .progress-fill.yellow { background-color: #fbbc05; }

    /* Activity item */
    .activity-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        gap: 12px;
        cursor: pointer;
        transition: background-color 0.1s;
    }

    .activity-item:hover {
        background-color: #f8f9fa;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .activity-icon.commit { background-color: #e6f4ea; color: #34a853; }
    .activity-icon.message { background-color: #e8f0fe; color: #1a73e8; }
    .activity-icon.session { background-color: #fef7e0; color: #f9ab00; }
    .activity-icon.decision { background-color: #fce8e6; color: #ea4335; }
    .activity-icon.complete { background-color: #e6f4ea; color: #34a853; }

    /* Session row */
    .session-row {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.1s;
    }

    .session-row:hover {
        background-color: #f8f9fa;
    }

    .session-row:last-child {
        border-bottom: none;
    }

    /* Filter tabs */
    .filter-tab {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 16px;
        color: #5f6368;
        transition: background-color 0.15s, color 0.15s;
        cursor: pointer;
    }

    .filter-tab:hover {
        background-color: #f1f3f4;
    }

    .filter-tab.active {
        background-color: #e8eaed;
        color: #202124;
        font-weight: 500;
    }

    /* Section header consistent with inbox tabs */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid #e0e0e0;
    }

    .section-header h2 {
        font-size: 14px;
        font-weight: 500;
        color: #202124;
        letter-spacing: 0.1px;
    }
</style>
{{end}}

{{define "content"}}
<div class="dashboard-container p-6">
    <!-- Header -->
    <div class="dashboard-card mb-6">
        <div class="flex items-center justify-between px-6 py-4">
            <div>
                <h1 class="text-xl font-medium text-gray-900">Agent Dashboard</h1>
                <p class="text-sm text-gray-500 mt-0.5">Monitor and manage your Claude agents</p>
            </div>
            <div class="flex items-center gap-3">
                <button class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg
                               hover:bg-blue-700 shadow-sm transition-all"
                        hx-get="/agents/new"
                        hx-target="#modal-container">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Agent
                </button>
                <button class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg
                               hover:bg-green-700 shadow-sm transition-all"
                        hx-get="/sessions/new"
                        hx-target="#modal-container">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Start Session
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="dashboard-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Active Agents</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-active">{{.AgentStats.ActiveAgents}}</p>
                </div>
                <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center">
                    <span class="status-dot status-active"></span>
                </div>
            </div>
        </div>
        <div class="dashboard-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Running Sessions</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-sessions">{{.AgentStats.RunningSessions}}</p>
                </div>
                <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="dashboard-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Pending Messages</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-pending">{{.AgentStats.PendingMessages}}</p>
                </div>
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="dashboard-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Completed Today</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-completed">{{.AgentStats.CompletedToday}}</p>
                </div>
                <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid: Agents + Activity Feed -->
    <div class="grid grid-cols-3 gap-6">
        <!-- Agents List (2 columns) -->
        <div class="col-span-2">
            <div class="dashboard-card">
                <div class="section-header">
                    <h2>Agents</h2>
                    <div class="flex items-center gap-1">
                        <button class="filter-tab active"
                                hx-get="/api/agents/cards?filter=all"
                                hx-target="#agents-grid"
                                onclick="setActiveTab(this)">All</button>
                        <button class="filter-tab"
                                hx-get="/api/agents/cards?filter=active"
                                hx-target="#agents-grid"
                                onclick="setActiveTab(this)">Active</button>
                        <button class="filter-tab"
                                hx-get="/api/agents/cards?filter=idle"
                                hx-target="#agents-grid"
                                onclick="setActiveTab(this)">Idle</button>
                    </div>
                </div>
                <div id="agents-grid"
                     class="grid grid-cols-2 gap-4 p-4"
                     hx-get="/api/agents/cards"
                     hx-trigger="load"
                     hx-ext="sse"
                     sse-connect="/events/agents"
                     sse-swap="agent-update">
                    <!-- Agent cards loaded via HTMX -->
                </div>
            </div>
        </div>

        <!-- Activity Feed (1 column) -->
        <div class="col-span-1">
            <div class="dashboard-card h-full flex flex-col">
                <div class="section-header">
                    <h2>Activity Feed</h2>
                    <span class="flex items-center gap-1 text-xs text-green-600">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Live
                    </span>
                </div>
                <div id="activity-feed"
                     class="flex-1 overflow-y-auto"
                     style="max-height: 400px;"
                     hx-get="/api/activity"
                     hx-trigger="load"
                     hx-ext="sse"
                     sse-connect="/events/activity"
                     sse-swap="activity-update:beforeend">
                    <!-- Activity items loaded via HTMX with SSE updates -->
                </div>
            </div>
        </div>
    </div>

    <!-- Active Sessions Section -->
    <div class="mt-6">
        <div class="dashboard-card">
            <div class="section-header">
                <h2>Active Sessions</h2>
                <a href="/sessions" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All</a>
            </div>
            <div id="sessions-list"
                 hx-get="/api/sessions/active"
                 hx-trigger="load, every 30s">
                <!-- Active sessions loaded via HTMX -->
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
function setActiveTab(btn) {
    // Remove active class from siblings
    btn.parentElement.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    // Add active class to clicked button
    btn.classList.add('active');
}
</script>
{{end}}
