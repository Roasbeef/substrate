{{define "inbox.html"}}
{{template "layout" .}}
{{end}}

{{define "title"}}{{.Title}} - Substrate{{end}}

{{define "head"}}
<style>
    /* Unified styles matching dashboard design */
    .inbox-container {
        background-color: #f5f5f5;
        min-height: calc(100vh - 56px);
    }

    .inbox-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    }

    .inbox-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e0e0e0;
    }

    /* Stats card hover effect */
    .stat-card {
        transition: box-shadow 0.15s, transform 0.15s;
    }

    .stat-card:hover {
        box-shadow: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
        transform: translateY(-1px);
    }

    /* Filter tabs matching dashboard */
    .filter-tab {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 16px;
        color: #5f6368;
        transition: background-color 0.15s, color 0.15s;
        cursor: pointer;
    }

    .filter-tab:hover {
        background-color: #f1f3f4;
    }

    .filter-tab.active {
        background-color: #e8eaed;
        color: #202124;
        font-weight: 500;
    }

    /* Section header consistent with dashboard */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid #e0e0e0;
    }

    .section-header h2 {
        font-size: 14px;
        font-weight: 500;
        color: #202124;
        letter-spacing: 0.1px;
    }

    /* Category tabs - dashboard style pills */
    .category-tabs {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #fafafa;
    }

    .category-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 20px;
        color: #5f6368;
        background: white;
        border: 1px solid #e0e0e0;
        text-decoration: none;
        transition: all 0.15s;
    }

    .category-tab:hover {
        border-color: #dadce0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .category-tab.active {
        border-color: transparent;
    }

    .category-tab.primary.active {
        background-color: #fce8e6;
        color: #d93025;
    }

    .category-tab.agents.active {
        background-color: #e8f0fe;
        color: #1a73e8;
    }

    .category-tab.topics.active {
        background-color: #e6f4ea;
        color: #188038;
    }

    .category-tab svg {
        width: 16px;
        height: 16px;
    }

    .category-tab .count {
        background: rgba(0,0,0,0.08);
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
    }

    .category-tab.active .count {
        background: rgba(0,0,0,0.1);
    }

    /* Time section dividers */
    .time-section {
        padding: 12px 16px 8px 16px;
        font-size: 12px;
        font-weight: 500;
        color: #5f6368;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        background: #fafafa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .time-section .mark-done {
        color: #5f6368;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .time-section:hover .mark-done {
        opacity: 1;
    }

    /* Message card - dashboard style */
    .message-card {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: background-color 0.1s;
        gap: 12px;
    }

    .message-card:hover {
        background-color: #f8f9fa;
    }

    .message-card:last-child {
        border-bottom: none;
    }

    .message-card.unread {
        background-color: #fff;
    }

    .message-card.unread .message-sender,
    .message-card.unread .message-subject {
        font-weight: 600;
        color: #202124;
    }

    /* Message avatar/icon */
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-weight: 600;
        font-size: 14px;
    }

    .message-avatar.agent { background-color: #e8f0fe; color: #1a73e8; }
    .message-avatar.topic { background-color: #e6f4ea; color: #188038; }
    .message-avatar.user { background-color: #fef7e0; color: #f9ab00; }

    /* Message content area */
    .message-content {
        flex: 1;
        min-width: 0;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .message-sender {
        font-size: 14px;
        font-weight: 500;
        color: #202124;
    }

    .message-time {
        font-size: 12px;
        color: #5f6368;
        margin-left: auto;
    }

    .message-subject {
        font-size: 14px;
        color: #202124;
        font-weight: 500;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .message-preview {
        font-size: 13px;
        color: #5f6368;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .message-tags {
        display: flex;
        gap: 6px;
        margin-top: 8px;
    }

    .message-tag {
        display: inline-block;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 500;
        border-radius: 4px;
        background: #e8eaed;
        color: #5f6368;
    }

    /* Message actions */
    .message-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        flex-shrink: 0;
    }

    .message-actions-row {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .message-card:hover .message-actions-row {
        opacity: 1;
    }

    .message-action-btn {
        padding: 6px;
        border-radius: 50%;
        color: #5f6368;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background-color 0.1s;
    }

    .message-action-btn:hover {
        background-color: #e8eaed;
    }

    .message-action-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Star button */
    .star-btn {
        color: #5f6368;
    }

    .star-btn.starred {
        color: #fbbc05;
    }

    /* Priority indicator */
    .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 500;
        border-radius: 4px;
    }

    .priority-badge.urgent {
        background-color: #fce8e6;
        color: #d93025;
    }

    .priority-badge.normal {
        background-color: #e8f0fe;
        color: #1a73e8;
    }

    /* Empty state */
    .inbox-empty {
        padding: 80px 24px;
        text-align: center;
    }

    .inbox-empty svg {
        width: 120px;
        height: 120px;
        color: #dadce0;
        margin: 0 auto 16px;
    }

    .inbox-empty h3 {
        font-size: 22px;
        font-weight: 400;
        color: #202124;
        margin-bottom: 8px;
    }

    .inbox-empty p {
        font-size: 14px;
        color: #5f6368;
    }
</style>
{{end}}

{{define "content"}}
<div class="inbox-container p-6">
    <!-- Header -->
    <div class="inbox-card mb-6">
        <div class="flex items-center justify-between px-6 py-4">
            <div>
                <h1 class="text-xl font-medium text-gray-900">{{.Title}}</h1>
                <p class="text-sm text-gray-500 mt-0.5">{{if eq .ActiveNav "inbox"}}Messages from agents and topics{{else if eq .ActiveNav "starred"}}Your starred messages{{else if eq .ActiveNav "snoozed"}}Messages snoozed for later{{else if eq .ActiveNav "sent"}}Messages you've sent{{else if eq .ActiveNav "archive"}}Archived messages{{else}}Messages from agents and topics{{end}}</p>
            </div>
            <div class="flex items-center gap-3">
                <button class="flex items-center gap-2 px-4 py-2 text-gray-700 text-sm font-medium rounded-lg
                               border border-gray-300 hover:bg-gray-50 transition-all"
                        hx-get="{{if .MessagesEndpoint}}{{.MessagesEndpoint}}{{else}}/inbox/messages{{end}}"
                        hx-target="#message-list"
                        hx-swap="innerHTML">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
                <button class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg
                               hover:bg-blue-700 shadow-sm transition-all"
                        hx-get="/compose"
                        hx-target="#modal-container">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Compose
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="inbox-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Unread</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-unread">{{.Stats.Unread}}</p>
                </div>
                <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="inbox-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Starred</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-starred">{{.Stats.Starred}}</p>
                </div>
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="inbox-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Snoozed</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-snoozed">{{.Stats.Snoozed}}</p>
                </div>
                <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="inbox-card stat-card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Urgent</p>
                    <p class="text-2xl font-semibold text-gray-900 mt-1" id="stat-urgent">{{.Stats.Urgent}}</p>
                </div>
                <div class="w-10 h-10 bg-red-50 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="inbox-card">
        <!-- Category Tabs -->
        <div class="category-tabs">
            <a href="/inbox?category=primary"
               class="category-tab primary {{if or (not .Category) (eq .Category "primary")}}active{{end}}">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                </svg>
                Primary
                {{if .Stats.PrimaryCount}}<span class="count">{{.Stats.PrimaryCount}}</span>{{end}}
            </a>
            <a href="/inbox?category=agents"
               class="category-tab agents {{if eq .Category "agents"}}active{{end}}">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                Agents
                {{if .Stats.AgentsCount}}<span class="count">{{.Stats.AgentsCount}}</span>{{end}}
            </a>
            <a href="/inbox?category=topics"
               class="category-tab topics {{if eq .Category "topics"}}active{{end}}">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                </svg>
                Topics
                {{if .Stats.TopicsCount}}<span class="count">{{.Stats.TopicsCount}}</span>{{end}}
            </a>
        </div>

        <!-- Filter Bar -->
        <div class="section-header">
            <h2>Messages</h2>
            <div class="flex items-center gap-1">
                <button class="filter-tab active"
                        hx-get="/inbox/messages?filter=all"
                        hx-target="#message-list"
                        onclick="setActiveTab(this)">All</button>
                <button class="filter-tab"
                        hx-get="/inbox/messages?filter=unread"
                        hx-target="#message-list"
                        onclick="setActiveTab(this)">Unread</button>
                <button class="filter-tab"
                        hx-get="/inbox/messages?filter=starred"
                        hx-target="#message-list"
                        onclick="setActiveTab(this)">Starred</button>
            </div>
        </div>

        <!-- Message List - SSE triggers refresh, morph prevents flicker -->
        <div id="message-list"
             hx-get="{{if .MessagesEndpoint}}{{.MessagesEndpoint}}{{else}}/inbox/messages{{end}}"
             hx-trigger="load, refresh"
             hx-swap="morph:innerHTML">
            <div class="p-8 text-center text-gray-500">
                <svg class="animate-spin w-6 h-6 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                Loading...
            </div>
        </div>
    </div>
</div>

<!-- SSE for real-time updates - JavaScript handles new-message events to trigger refresh -->
<div hx-ext="sse" sse-connect="/events/inbox" class="hidden">
    <div sse-swap="unread-count" hx-swap="innerHTML" hx-target="#stat-unread"></div>
</div>
{{end}}

{{define "scripts"}}
<script>
function setActiveTab(btn) {
    btn.parentElement.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    btn.classList.add('active');
}
</script>
{{end}}
