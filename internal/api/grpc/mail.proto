syntax = "proto3";

package subtraterpc;

option go_package = "github.com/roasbeef/subtrate/internal/api/grpc/subtraterpc";

import "google/protobuf/timestamp.proto";

// Mail is the main RPC service for the Subtrate mail system. It provides
// methods for sending, receiving, and managing messages between agents.
service Mail {
    // SendMail sends a new message to one or more recipients.
    rpc SendMail (SendMailRequest) returns (SendMailResponse);

    // FetchInbox retrieves messages from an agent's inbox.
    rpc FetchInbox (FetchInboxRequest) returns (FetchInboxResponse);

    // ReadMessage retrieves a single message by ID and marks it as read.
    rpc ReadMessage (ReadMessageRequest) returns (ReadMessageResponse);

    // ReadThread retrieves all messages in a thread.
    rpc ReadThread (ReadThreadRequest) returns (ReadThreadResponse);

    // UpdateState changes the state of a message (star, snooze, archive, trash).
    rpc UpdateState (UpdateStateRequest) returns (UpdateStateResponse);

    // AckMessage acknowledges receipt of a message with a deadline.
    rpc AckMessage (AckMessageRequest) returns (AckMessageResponse);

    // GetStatus returns the mail status for an agent.
    rpc GetStatus (GetStatusRequest) returns (GetStatusResponse);

    // PollChanges checks for new messages since given offsets.
    rpc PollChanges (PollChangesRequest) returns (PollChangesResponse);

    // SubscribeInbox creates a stream of new inbox messages.
    rpc SubscribeInbox (SubscribeInboxRequest) returns (stream InboxMessage);

    // Publish sends a message to a pub/sub topic.
    rpc Publish (PublishRequest) returns (PublishResponse);

    // Subscribe subscribes an agent to a topic.
    rpc Subscribe (SubscribeRequest) returns (SubscribeResponse);

    // Unsubscribe removes an agent's subscription to a topic.
    rpc Unsubscribe (UnsubscribeRequest) returns (UnsubscribeResponse);

    // ListTopics lists available topics.
    rpc ListTopics (ListTopicsRequest) returns (ListTopicsResponse);

    // Search performs full-text search across messages.
    rpc Search (SearchRequest) returns (SearchResponse);

    // HasUnackedStatusTo checks if there are unacked status messages from
    // sender to recipient. Used for deduplication in status-update command.
    rpc HasUnackedStatusTo (HasUnackedStatusToRequest) returns (HasUnackedStatusToResponse);

    // ReplyToThread sends a reply message to an existing thread.
    rpc ReplyToThread (ReplyToThreadRequest) returns (ReplyToThreadResponse);

    // ArchiveThread archives all messages in a thread.
    rpc ArchiveThread (ArchiveThreadRequest) returns (ArchiveThreadResponse);

    // DeleteThread deletes all messages in a thread.
    rpc DeleteThread (DeleteThreadRequest) returns (DeleteThreadResponse);

    // MarkThreadUnread marks a thread as unread.
    rpc MarkThreadUnread (MarkThreadUnreadRequest) returns (MarkThreadUnreadResponse);

    // GetTopic retrieves a single topic by ID.
    rpc GetTopic (GetTopicRequest) returns (GetTopicResponse);

    // AutocompleteRecipients returns matching agents for autocomplete.
    rpc AutocompleteRecipients (AutocompleteRecipientsRequest) returns (AutocompleteRecipientsResponse);

    // DeleteMessage marks a message as deleted/trash.
    rpc DeleteMessage (DeleteMessageRequest) returns (DeleteMessageResponse);
}

// Agent is the RPC service for managing agent identities.
service Agent {
    // RegisterAgent creates a new agent with the given name.
    rpc RegisterAgent (RegisterAgentRequest) returns (RegisterAgentResponse);

    // GetAgent retrieves an agent by ID or name.
    rpc GetAgent (GetAgentRequest) returns (GetAgentResponse);

    // ListAgents lists all registered agents.
    rpc ListAgents (ListAgentsRequest) returns (ListAgentsResponse);

    // DeleteAgent removes an agent by ID.
    rpc DeleteAgent (DeleteAgentRequest) returns (DeleteAgentResponse);

    // UpdateAgent updates an agent's properties.
    rpc UpdateAgent (UpdateAgentRequest) returns (UpdateAgentResponse);

    // GetAgentsStatus returns all agents with their status and counts.
    rpc GetAgentsStatus (GetAgentsStatusRequest) returns (GetAgentsStatusResponse);

    // Heartbeat records a heartbeat for an agent.
    rpc Heartbeat (HeartbeatRequest) returns (HeartbeatResponse);

    // EnsureIdentity creates or retrieves an agent identity for a session.
    rpc EnsureIdentity (EnsureIdentityRequest) returns (EnsureIdentityResponse);

    // SaveIdentity persists an agent's current state.
    rpc SaveIdentity (SaveIdentityRequest) returns (SaveIdentityResponse);

    // DiscoverAgents returns all agents with discovery metadata including
    // status, working directory, purpose, hostname, and unread counts.
    rpc DiscoverAgents (DiscoverAgentsRequest) returns (DiscoverAgentsResponse);
}

// Session is the RPC service for managing agent sessions.
service Session {
    // ListSessions lists all sessions with optional filters.
    rpc ListSessions (ListSessionsRequest) returns (ListSessionsResponse);

    // GetSession retrieves a single session by ID.
    rpc GetSession (GetSessionRequest) returns (GetSessionResponse);

    // StartSession starts a new session for an agent.
    rpc StartSession (StartSessionRequest) returns (StartSessionResponse);

    // CompleteSession marks a session as completed.
    rpc CompleteSession (CompleteSessionRequest) returns (CompleteSessionResponse);
}

// Activity is the RPC service for activity feeds.
service Activity {
    // ListActivities lists activities with optional filters.
    rpc ListActivities (ListActivitiesRequest) returns (ListActivitiesResponse);
}

// Stats is the RPC service for dashboard statistics.
service Stats {
    // GetDashboardStats returns dashboard statistics.
    rpc GetDashboardStats (GetDashboardStatsRequest) returns (GetDashboardStatsResponse);

    // HealthCheck returns server health status.
    rpc HealthCheck (HealthCheckRequest) returns (HealthCheckResponse);
}

// TaskService handles Claude Code task operations.
service TaskService {
    // RegisterTaskList registers a new task list for an agent.
    rpc RegisterTaskList (RegisterTaskListRequest) returns (RegisterTaskListResponse);

    // GetTaskList retrieves a task list by ID.
    rpc GetTaskList (GetTaskListRequest) returns (GetTaskListResponse);

    // ListTaskLists lists registered task lists.
    rpc ListTaskLists (ListTaskListsRequest) returns (ListTaskListsResponse);

    // UnregisterTaskList removes a task list registration.
    rpc UnregisterTaskList (UnregisterTaskListRequest) returns (UnregisterTaskListResponse);

    // UpsertTask creates or updates a task.
    rpc UpsertTask (UpsertTaskRequest) returns (UpsertTaskResponse);

    // GetTask retrieves a task by Claude task ID.
    rpc GetTask (GetTaskProtoRequest) returns (GetTaskResponse);

    // ListTasks lists tasks with optional filters.
    rpc ListTasks (ListTasksRequest) returns (ListTasksResponse);

    // UpdateTaskStatus updates a task's status.
    rpc UpdateTaskStatus (UpdateTaskStatusRequest) returns (UpdateTaskStatusResponse);

    // UpdateTaskOwner assigns an owner to a task.
    rpc UpdateTaskOwner (UpdateTaskOwnerRequest) returns (UpdateTaskOwnerResponse);

    // DeleteTask deletes a task.
    rpc DeleteTask (DeleteTaskRequest) returns (DeleteTaskResponse);

    // GetTaskStats retrieves task statistics.
    rpc GetTaskStats (GetTaskStatsRequest) returns (GetTaskStatsResponse);

    // GetAllAgentTaskStats retrieves task stats grouped by agent.
    rpc GetAllAgentTaskStats (GetAllAgentTaskStatsRequest) returns (GetAllAgentTaskStatsResponse);

    // SyncTaskList triggers a sync of a task list.
    rpc SyncTaskList (SyncTaskListRequest) returns (SyncTaskListResponse);

    // PruneOldTasks removes old completed/deleted tasks.
    rpc PruneOldTasks (PruneOldTasksRequest) returns (PruneOldTasksResponse);
}

// ReviewService handles code review operations.
service ReviewService {
    // CreateReview creates a new review request.
    rpc CreateReview (CreateReviewRequest) returns (CreateReviewResponse);

    // ListReviews lists reviews with optional filters.
    rpc ListReviews (ListReviewsProtoRequest) returns (ListReviewsProtoResponse);

    // GetReview gets a single review with its iterations.
    rpc GetReview (GetReviewProtoRequest) returns (ReviewDetailResponse);

    // ResubmitReview re-requests review after author changes.
    rpc ResubmitReview (ResubmitReviewRequest) returns (CreateReviewResponse);

    // CancelReview cancels an active review.
    rpc CancelReview (CancelReviewProtoRequest) returns (CancelReviewProtoResponse);

    // DeleteReview permanently removes a review and all associated data.
    rpc DeleteReview (DeleteReviewProtoRequest) returns (DeleteReviewProtoResponse);

    // ListReviewIssues lists issues for a review.
    rpc ListReviewIssues (ListReviewIssuesRequest) returns (ListReviewIssuesResponse);

    // UpdateIssueStatus updates the status of a review issue.
    rpc UpdateIssueStatus (UpdateIssueStatusRequest) returns (UpdateIssueStatusResponse);

    // GetReviewDiff returns the git diff for a review's branch.
    rpc GetReviewDiff (GetReviewDiffRequest) returns (GetReviewDiffResponse);
}

// Priority represents message priority levels.
enum Priority {
    PRIORITY_UNSPECIFIED = 0;
    PRIORITY_LOW = 1;
    PRIORITY_NORMAL = 2;
    PRIORITY_URGENT = 3;
}

// MessageState represents the state of a message for a recipient.
enum MessageState {
    STATE_UNSPECIFIED = 0;
    STATE_UNREAD = 1;
    STATE_READ = 2;
    STATE_STARRED = 3;
    STATE_SNOOZED = 4;
    STATE_ARCHIVED = 5;
    STATE_TRASH = 6;
}

// InboxMessage represents a message in an agent's inbox.
// Note: int64 fields serialize as strings in JSON (protobuf standard).
// Timestamps use RFC 3339 format. Priority/state serialize as enum strings.
message InboxMessage {
    int64 id = 1;
    string thread_id = 2;
    int64 topic_id = 3;
    int64 sender_id = 4;
    string sender_name = 5;
    string sender_project_key = 15;  // Agent's project key (e.g., "substrate").
    string sender_git_branch = 16;   // Agent's git branch (e.g., "main").
    string subject = 6;
    string body = 7;
    Priority priority = 8;
    MessageState state = 9;
    google.protobuf.Timestamp created_at = 10;
    google.protobuf.Timestamp deadline_at = 11;      // null if no deadline
    google.protobuf.Timestamp snoozed_until = 12;    // null if not snoozed
    google.protobuf.Timestamp read_at = 13;          // null if unread
    google.protobuf.Timestamp acknowledged_at = 14;  // null if not acked
    repeated string recipient_names = 17;            // Names of all recipients.
}

// SendMailRequest is the request for SendMail.
message SendMailRequest {
    int64 sender_id = 1;
    repeated string recipient_names = 2;
    string topic_name = 3;          // For pub/sub, mutually exclusive with recipients
    string thread_id = 4;           // Optional, for replies
    string subject = 5;
    string body = 6;
    Priority priority = 7;
    google.protobuf.Timestamp deadline_at = 8;  // Optional deadline
    string attachments_json = 9;    // JSON string of attachments
    string idempotency_key = 10;    // Optional key for deduplication
}

// SendMailResponse is the response for SendMail.
message SendMailResponse {
    int64 message_id = 1;
    string thread_id = 2;
}

// FetchInboxRequest is the request for FetchInbox.
message FetchInboxRequest {
    int64 agent_id = 1;
    int32 limit = 2;            // Maximum messages to return
    bool unread_only = 3;       // Only return unread messages
    MessageState state_filter = 4;  // Filter by state
    bool sent_only = 5;         // Only return messages sent by the agent
    // sender_name_prefix filters to messages from agents whose name starts with
    // this prefix (e.g., "reviewer-" for CodeReviewer aggregate).
    string sender_name_prefix = 6;
}

// FetchInboxResponse is the response for FetchInbox.
message FetchInboxResponse {
    repeated InboxMessage messages = 1;
}

// ReadMessageRequest is the request for ReadMessage.
message ReadMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
}

// ReadMessageResponse is the response for ReadMessage.
message ReadMessageResponse {
    InboxMessage message = 1;
}

// ReadThreadRequest is the request for ReadThread.
message ReadThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// ReadThreadResponse is the response for ReadThread.
message ReadThreadResponse {
    repeated InboxMessage messages = 1;
}

// UpdateStateRequest is the request for UpdateState.
message UpdateStateRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
    MessageState new_state = 3;
    google.protobuf.Timestamp snoozed_until = 4;    // Required for STATE_SNOOZED
}

// UpdateStateResponse is the response for UpdateState.
message UpdateStateResponse {
    bool success = 1;
}

// AckMessageRequest is the request for AckMessage.
message AckMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
}

// AckMessageResponse is the response for AckMessage.
message AckMessageResponse {
    bool success = 1;
}

// GetStatusRequest is the request for GetStatus.
message GetStatusRequest {
    int64 agent_id = 1;
}

// GetStatusResponse is the response for GetStatus.
message GetStatusResponse {
    int64 agent_id = 1;
    string agent_name = 2;
    int64 unread_count = 3;
    int64 urgent_count = 4;
    int64 starred_count = 5;
    int64 snoozed_count = 6;
}

// PollChangesRequest is the request for PollChanges.
message PollChangesRequest {
    int64 agent_id = 1;
    map<int64, int64> since_offsets = 2;    // topic_id -> last_offset
}

// PollChangesResponse is the response for PollChanges.
message PollChangesResponse {
    repeated InboxMessage new_messages = 1;
    map<int64, int64> new_offsets = 2;      // topic_id -> new_offset
}

// SubscribeInboxRequest is the request for SubscribeInbox streaming.
message SubscribeInboxRequest {
    int64 agent_id = 1;
}

// PublishRequest is the request for Publish.
message PublishRequest {
    int64 sender_id = 1;
    string topic_name = 2;
    string subject = 3;
    string body = 4;
    Priority priority = 5;
    string idempotency_key = 6;     // Optional key for deduplication
}

// PublishResponse is the response for Publish.
message PublishResponse {
    int64 message_id = 1;
    int32 recipients_count = 2;
}

// SubscribeRequest is the request for Subscribe.
message SubscribeRequest {
    int64 agent_id = 1;
    string topic_name = 2;
}

// SubscribeResponse is the response for Subscribe.
message SubscribeResponse {
    bool success = 1;
    int64 topic_id = 2;
}

// UnsubscribeRequest is the request for Unsubscribe.
message UnsubscribeRequest {
    int64 agent_id = 1;
    string topic_name = 2;
}

// UnsubscribeResponse is the response for Unsubscribe.
message UnsubscribeResponse {
    bool success = 1;
}

// Topic represents a pub/sub topic.
message Topic {
    int64 id = 1;
    string name = 2;
    string topic_type = 3;      // "direct", "broadcast", "queue"
    google.protobuf.Timestamp created_at = 4;
    int64 message_count = 5;    // Number of messages in this topic
}

// ListTopicsRequest is the request for ListTopics.
message ListTopicsRequest {
    int64 agent_id = 1;         // If set, only show subscribed topics
    bool subscribed_only = 2;
}

// ListTopicsResponse is the response for ListTopics.
message ListTopicsResponse {
    repeated Topic topics = 1;
}

// SearchRequest is the request for Search.
message SearchRequest {
    int64 agent_id = 1;
    string query = 2;
    int64 topic_id = 3;         // Optional, filter by topic
    int32 limit = 4;
}

// SearchResponse is the response for Search.
message SearchResponse {
    repeated InboxMessage results = 1;
}

// HasUnackedStatusToRequest is the request for HasUnackedStatusTo.
message HasUnackedStatusToRequest {
    int64 sender_id = 1;
    int64 recipient_id = 2;
}

// HasUnackedStatusToResponse is the response for HasUnackedStatusTo.
message HasUnackedStatusToResponse {
    bool has_pending = 1;
}

// RegisterAgentRequest is the request for RegisterAgent.
message RegisterAgentRequest {
    string name = 1;
    string project_key = 2;     // Optional project binding
}

// RegisterAgentResponse is the response for RegisterAgent.
message RegisterAgentResponse {
    int64 agent_id = 1;
    string name = 2;
}

// GetAgentRequest is the request for GetAgent.
message GetAgentRequest {
    int64 agent_id = 1;         // Use ID or name
    string name = 2;
}

// GetAgentResponse is the response for GetAgent.
// Note: int64 fields serialize as strings in JSON (protobuf standard).
message GetAgentResponse {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string session_id = 4;  // Current session ID (renamed from current_session_id)
    google.protobuf.Timestamp created_at = 5;
    google.protobuf.Timestamp last_active_at = 6;
    string git_branch = 7;
}

// ListAgentsRequest is the request for ListAgents.
message ListAgentsRequest {
    int32 limit = 1;
}

// ListAgentsResponse is the response for ListAgents.
message ListAgentsResponse {
    repeated GetAgentResponse agents = 1;
}

// EnsureIdentityRequest is the request for EnsureIdentity.
message EnsureIdentityRequest {
    string session_id = 1;
    string project_dir = 2;
    string git_branch = 3;
}

// EnsureIdentityResponse is the response for EnsureIdentity.
message EnsureIdentityResponse {
    int64 agent_id = 1;
    string agent_name = 2;
    bool created = 3;           // True if a new agent was created
}

// SaveIdentityRequest is the request for SaveIdentity.
message SaveIdentityRequest {
    string session_id = 1;
    int64 agent_id = 2;
    map<int64, int64> consumer_offsets = 3;     // topic_id -> offset
}

// SaveIdentityResponse is the response for SaveIdentity.
message SaveIdentityResponse {
    bool success = 1;
}

// DeleteAgentRequest is the request for DeleteAgent.
message DeleteAgentRequest {
    int64 id = 1;
}

// DeleteAgentResponse is the response for DeleteAgent.
message DeleteAgentResponse {
    bool success = 1;
}

// =============================================================================
// New Message Types for Extended API
// =============================================================================

// ReplyToThreadRequest is the request for ReplyToThread.
message ReplyToThreadRequest {
    int64 sender_id = 1;
    string thread_id = 2;
    string body = 3;
}

// ReplyToThreadResponse is the response for ReplyToThread.
message ReplyToThreadResponse {
    int64 message_id = 1;
}

// ArchiveThreadRequest is the request for ArchiveThread.
message ArchiveThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// ArchiveThreadResponse is the response for ArchiveThread.
message ArchiveThreadResponse {
    bool success = 1;
    int32 messages_archived = 2;
}

// DeleteThreadRequest is the request for DeleteThread.
message DeleteThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// DeleteThreadResponse is the response for DeleteThread.
message DeleteThreadResponse {
    bool success = 1;
    int32 messages_deleted = 2;
}

// MarkThreadUnreadRequest is the request for MarkThreadUnread.
message MarkThreadUnreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// MarkThreadUnreadResponse is the response for MarkThreadUnread.
message MarkThreadUnreadResponse {
    bool success = 1;
}

// GetTopicRequest is the request for GetTopic.
message GetTopicRequest {
    int64 topic_id = 1;
}

// GetTopicResponse is the response for GetTopic.
message GetTopicResponse {
    Topic topic = 1;
}

// AutocompleteRecipientsRequest is the request for AutocompleteRecipients.
message AutocompleteRecipientsRequest {
    string query = 1;
    int32 limit = 2;
}

// AutocompleteRecipient represents a recipient suggestion.
message AutocompleteRecipient {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string git_branch = 4;
    string status = 5;  // "active", "busy", "idle", "offline"
}

// AutocompleteRecipientsResponse is the response for AutocompleteRecipients.
message AutocompleteRecipientsResponse {
    repeated AutocompleteRecipient recipients = 1;
}

// DeleteMessageRequest is the request for DeleteMessage.
message DeleteMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
    // mark_sender_deleted marks the message as deleted from sender's perspective.
    // Used when deleting from aggregate views like CodeReviewer.
    bool mark_sender_deleted = 3;
}

// DeleteMessageResponse is the response for DeleteMessage.
message DeleteMessageResponse {
    bool success = 1;
}

// UpdateAgentRequest is the request for UpdateAgent.
message UpdateAgentRequest {
    int64 id = 1;
    string project_key = 2;
    string git_branch = 3;
}

// UpdateAgentResponse is the response for UpdateAgent.
message UpdateAgentResponse {
    GetAgentResponse agent = 1;
}

// AgentStatus represents an agent's current status.
enum AgentStatus {
    AGENT_STATUS_UNSPECIFIED = 0;
    AGENT_STATUS_ACTIVE = 1;
    AGENT_STATUS_BUSY = 2;
    AGENT_STATUS_IDLE = 3;
    AGENT_STATUS_OFFLINE = 4;
}

// AgentWithStatus represents an agent with its current status.
message AgentWithStatus {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string git_branch = 4;
    AgentStatus status = 5;
    google.protobuf.Timestamp last_active_at = 6;
    int64 session_id = 7;
    int64 seconds_since_heartbeat = 8;
}

// AgentStatusCounts represents counts of agents by status.
message AgentStatusCounts {
    int32 active = 1;
    int32 busy = 2;
    int32 idle = 3;
    int32 offline = 4;
}

// GetAgentsStatusRequest is the request for GetAgentsStatus.
message GetAgentsStatusRequest {}

// GetAgentsStatusResponse is the response for GetAgentsStatus.
message GetAgentsStatusResponse {
    repeated AgentWithStatus agents = 1;
    AgentStatusCounts counts = 2;
}

// DiscoverAgentsRequest is the request for DiscoverAgents.
message DiscoverAgentsRequest {
    // status_filter filters by agent status (match any). Empty means all.
    repeated AgentStatus status_filter = 1;
    // project_filter filters by project key prefix.
    string project_filter = 2;
    // name_filter filters by agent name substring.
    string name_filter = 3;
}

// DiscoveredAgent represents an agent with full discovery metadata.
message DiscoveredAgent {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string git_branch = 4;
    AgentStatus status = 5;
    google.protobuf.Timestamp last_active_at = 6;
    int64 seconds_since_heartbeat = 7;
    string session_id = 8;
    string purpose = 9;
    string working_dir = 10;
    string hostname = 11;
    int64 unread_count = 12;
}

// DiscoverAgentsResponse is the response for DiscoverAgents.
message DiscoverAgentsResponse {
    repeated DiscoveredAgent agents = 1;
    AgentStatusCounts counts = 2;
}

// HeartbeatRequest is the request for Heartbeat.
// Either agent_id or agent_name must be provided. If both are given,
// agent_id takes precedence.
message HeartbeatRequest {
    int64 agent_id = 1 [json_name = "agent_id"];
    string session_id = 2 [json_name = "session_id"];
    string agent_name = 3 [json_name = "agent_name"];
}

// HeartbeatResponse is the response for Heartbeat.
message HeartbeatResponse {
    bool success = 1;
}

// =============================================================================
// Session Service Messages
// =============================================================================

// SessionStatus represents the status of a session.
enum SessionStatus {
    SESSION_STATUS_UNSPECIFIED = 0;
    SESSION_STATUS_ACTIVE = 1;
    SESSION_STATUS_COMPLETED = 2;
    SESSION_STATUS_ABANDONED = 3;
}

// SessionInfo represents a session.
message SessionInfo {
    int64 id = 1;
    int64 agent_id = 2;
    string agent_name = 3;
    string project = 4;
    string branch = 5;
    google.protobuf.Timestamp started_at = 6;
    google.protobuf.Timestamp ended_at = 7;
    SessionStatus status = 8;
}

// ListSessionsRequest is the request for ListSessions.
message ListSessionsRequest {
    bool active_only = 1;
    int32 limit = 2;
}

// ListSessionsResponse is the response for ListSessions.
message ListSessionsResponse {
    repeated SessionInfo sessions = 1;
}

// GetSessionRequest is the request for GetSession.
message GetSessionRequest {
    int64 session_id = 1;
}

// GetSessionResponse is the response for GetSession.
message GetSessionResponse {
    SessionInfo session = 1;
}

// StartSessionRequest is the request for StartSession.
message StartSessionRequest {
    int64 agent_id = 1;
    string project = 2;
    string branch = 3;
}

// StartSessionResponse is the response for StartSession.
message StartSessionResponse {
    SessionInfo session = 1;
}

// CompleteSessionRequest is the request for CompleteSession.
message CompleteSessionRequest {
    int64 session_id = 1;
}

// CompleteSessionResponse is the response for CompleteSession.
message CompleteSessionResponse {
    bool success = 1;
}

// =============================================================================
// Activity Service Messages
// =============================================================================

// ActivityType represents the type of an activity.
enum ActivityType {
    ACTIVITY_TYPE_UNSPECIFIED = 0;
    ACTIVITY_TYPE_MESSAGE_SENT = 1;
    ACTIVITY_TYPE_MESSAGE_READ = 2;
    ACTIVITY_TYPE_SESSION_STARTED = 3;
    ACTIVITY_TYPE_SESSION_COMPLETED = 4;
    ACTIVITY_TYPE_AGENT_REGISTERED = 5;
    ACTIVITY_TYPE_HEARTBEAT = 6;
}

// ActivityInfo represents an activity entry.
message ActivityInfo {
    int64 id = 1;
    int64 agent_id = 2;
    string agent_name = 3;
    ActivityType type = 4;
    string description = 5;
    google.protobuf.Timestamp created_at = 6;
    string metadata_json = 7;  // JSON-encoded metadata
}

// ListActivitiesRequest is the request for ListActivities.
message ListActivitiesRequest {
    int64 agent_id = 1;         // Filter by agent (0 = all)
    ActivityType type = 2;      // Filter by type (UNSPECIFIED = all)
    int32 page = 3;
    int32 page_size = 4;
}

// ListActivitiesResponse is the response for ListActivities.
message ListActivitiesResponse {
    repeated ActivityInfo activities = 1;
    int64 total = 2;
    int32 page = 3;
    int32 page_size = 4;
}

// =============================================================================
// Stats Service Messages
// =============================================================================

// DashboardStats represents dashboard statistics.
message DashboardStats {
    int32 active_agents = 1;
    int32 running_sessions = 2;
    int32 pending_messages = 3;
    int32 completed_today = 4;
}

// GetDashboardStatsRequest is the request for GetDashboardStats.
message GetDashboardStatsRequest {}

// GetDashboardStatsResponse is the response for GetDashboardStats.
message GetDashboardStatsResponse {
    DashboardStats stats = 1;
}

// HealthCheckRequest is the request for HealthCheck.
message HealthCheckRequest {}

// HealthCheckResponse is the response for HealthCheck.
message HealthCheckResponse {
    string status = 1;  // "ok" or "error"
    google.protobuf.Timestamp time = 2;
}

// =============================================================================
// ReviewService Messages
// =============================================================================

// BranchTarget specifies a full branch diff review.
message BranchTarget {
    // branch is the feature branch to review.
    string branch = 1;
    // base_branch is the branch to diff against (e.g., "main").
    string base_branch = 2;
}

// CommitTarget specifies a single commit review.
message CommitTarget {
    // sha is the commit SHA to review.
    string sha = 1;
    // branch is the branch name for display/naming purposes only.
    string branch = 2;
}

// CommitRangeTarget specifies a range of commits to review.
message CommitRangeTarget {
    // start_sha is the first commit in the range (exclusive).
    string start_sha = 1;
    // end_sha is the last commit in the range (inclusive).
    string end_sha = 2;
    // branch is the branch name for display/naming purposes only.
    string branch = 3;
}

// PRTarget specifies a pull request review.
message PRTarget {
    // number is the PR number.
    int32 number = 1;
    // branch is the PR's head branch.
    string branch = 2;
    // base_branch is the PR's base branch.
    string base_branch = 3;
}

// CreateReviewRequest is the request for CreateReview.
message CreateReviewRequest {
    // repo_path is the local path to the repository.
    string repo_path = 4;
    // remote_url is the git remote URL.
    string remote_url = 11;
    // review_type is the type of review: full, security, performance, architecture.
    string review_type = 6;
    // priority is the review priority: urgent, normal, low.
    string priority = 7;
    // reviewers is optional list of specific reviewers to assign.
    repeated string reviewers = 8;
    // description is an optional description of what to review.
    string description = 9;
    // requester_id is the agent ID requesting the review.
    int64 requester_id = 10;

    // target specifies what to review. Exactly one must be set.
    oneof target {
        // branch_target reviews a full branch diff against base.
        BranchTarget branch_target = 20;
        // commit_target reviews a single commit.
        CommitTarget commit_target = 21;
        // commit_range_target reviews a range of commits.
        CommitRangeTarget commit_range_target = 22;
        // pr_target reviews a pull request.
        PRTarget pr_target = 23;
    }

    // Deprecated fields kept for backward compatibility.
    // Use target oneof instead.
    string branch = 1 [deprecated = true];
    string base_branch = 2 [deprecated = true];
    string commit_sha = 3 [deprecated = true];
    int32 pr_number = 5 [deprecated = true];
}

// CreateReviewResponse is the response for CreateReview and ResubmitReview.
message CreateReviewResponse {
    string review_id = 1;
    string thread_id = 2;
    string state = 3;
    string error = 4;
}

// ListReviewsProtoRequest is the request for ListReviews.
message ListReviewsProtoRequest {
    string state = 1;             // Optional state filter
    int64 requester_id = 2;       // Optional requester filter
    int32 limit = 3;
    int32 offset = 4;
}

// ListReviewsProtoResponse is the response for ListReviews.
message ListReviewsProtoResponse {
    repeated ReviewSummaryProto reviews = 1;
}

// ReviewSummaryProto represents a review summary in proto format.
message ReviewSummaryProto {
    string review_id = 1;
    string thread_id = 2;
    int64 requester_id = 3;
    string branch = 4;
    string state = 5;
    string review_type = 6;
    int64 created_at = 7;
}

// GetReviewProtoRequest is the request for GetReview.
message GetReviewProtoRequest {
    string review_id = 1;
}

// ReviewDetailResponse is the response for GetReview.
message ReviewDetailResponse {
    string review_id = 1;
    string thread_id = 2;
    string state = 3;
    string branch = 4;
    string base_branch = 5;
    string review_type = 6;
    int32 iterations = 7;
    int64 open_issues = 8;
    string error = 9;
    // Iteration details for displaying review history.
    repeated ReviewIterationProto iteration_details = 10;
}

// ReviewIterationProto represents a single review iteration with results.
message ReviewIterationProto {
    int32 iteration_num = 1;
    string reviewer_id = 2;
    string decision = 3;
    string summary = 4;
    int32 files_reviewed = 5;
    int32 lines_analyzed = 6;
    int64 duration_ms = 7;
    double cost_usd = 8;
    int64 started_at = 9;
    int64 completed_at = 10;
}

// ResubmitReviewRequest is the request for ResubmitReview.
message ResubmitReviewRequest {
    string review_id = 1;
    string commit_sha = 2;
}

// CancelReviewProtoRequest is the request for CancelReview.
message CancelReviewProtoRequest {
    string review_id = 1;
    string reason = 2;
}

// CancelReviewProtoResponse is the response for CancelReview.
message CancelReviewProtoResponse {
    string error = 1;
}

// DeleteReviewProtoRequest is the request for DeleteReview.
message DeleteReviewProtoRequest {
    string review_id = 1;
}

// DeleteReviewProtoResponse is the response for DeleteReview.
message DeleteReviewProtoResponse {
    string error = 1;
}

// ListReviewIssuesRequest is the request for ListReviewIssues.
message ListReviewIssuesRequest {
    string review_id = 1;
}

// ListReviewIssuesResponse is the response for ListReviewIssues.
message ListReviewIssuesResponse {
    repeated ReviewIssueProto issues = 1;
}

// ReviewIssueProto represents a review issue in proto format.
message ReviewIssueProto {
    int64 id = 1;
    string review_id = 2;
    int32 iteration_num = 3;
    string issue_type = 4;
    string severity = 5;
    string file_path = 6;
    int32 line_start = 7;
    int32 line_end = 8;
    string title = 9;
    string description = 10;
    string code_snippet = 11;
    string suggestion = 12;
    string claude_md_ref = 13;
    string status = 14;
}

// UpdateIssueStatusRequest is the request for UpdateIssueStatus.
message UpdateIssueStatusRequest {
    string review_id = 1;
    int64 issue_id = 2;
    string status = 3;            // open, fixed, wont_fix, duplicate
}

// UpdateIssueStatusResponse is the response for UpdateIssueStatus.
message UpdateIssueStatusResponse {
    string error = 1;
}

// GetReviewDiffRequest is the request for GetReviewDiff.
message GetReviewDiffRequest {
    string review_id = 1;
}

// GetReviewDiffResponse is the response for GetReviewDiff.
message GetReviewDiffResponse {
    // The raw unified diff output from git diff.
    string patch = 1;
    // The git command that was run to produce the diff.
    string command = 2;
    string error = 3;
}

// =============================================================================
// TaskService Messages
// =============================================================================

// TaskStatus represents the status of a task.
enum TaskStatus {
    TASK_STATUS_UNSPECIFIED = 0;
    TASK_STATUS_PENDING = 1;
    TASK_STATUS_IN_PROGRESS = 2;
    TASK_STATUS_COMPLETED = 3;
    TASK_STATUS_DELETED = 4;
}

// TaskListProto represents a registered task list.
message TaskListProto {
    int64 id = 1;
    string list_id = 2;
    int64 agent_id = 3;
    string watch_path = 4;
    google.protobuf.Timestamp created_at = 5;
    google.protobuf.Timestamp last_synced_at = 6;
}

// TaskProto represents a Claude Code task.
message TaskProto {
    int64 id = 1;
    int64 agent_id = 2;
    string list_id = 3;
    string claude_task_id = 4;
    string subject = 5;
    string description = 6;
    string active_form = 7;
    string metadata_json = 8;
    TaskStatus status = 9;
    string owner = 10;
    repeated string blocked_by = 11;
    repeated string blocks = 12;
    google.protobuf.Timestamp created_at = 13;
    google.protobuf.Timestamp updated_at = 14;
    google.protobuf.Timestamp started_at = 15;
    google.protobuf.Timestamp completed_at = 16;
}

// TaskStatsProto contains aggregate task statistics.
message TaskStatsProto {
    int64 pending_count = 1;
    int64 in_progress_count = 2;
    int64 completed_count = 3;
    int64 blocked_count = 4;
    int64 available_count = 5;
    int64 completed_today = 6;
}

// AgentTaskStatsProto contains task statistics for a specific agent.
message AgentTaskStatsProto {
    int64 agent_id = 1;
    string agent_name = 2;
    int64 pending_count = 3;
    int64 in_progress_count = 4;
    int64 blocked_count = 5;
    int64 completed_today = 6;
}

// RegisterTaskListRequest is the request for RegisterTaskList.
message RegisterTaskListRequest {
    string list_id = 1;
    int64 agent_id = 2;
    string watch_path = 3;
}

// RegisterTaskListResponse is the response for RegisterTaskList.
message RegisterTaskListResponse {
    TaskListProto task_list = 1;
    string error = 2;
}

// GetTaskListRequest is the request for GetTaskList.
message GetTaskListRequest {
    string list_id = 1;
}

// GetTaskListResponse is the response for GetTaskList.
message GetTaskListResponse {
    TaskListProto task_list = 1;
    string error = 2;
}

// ListTaskListsRequest is the request for ListTaskLists.
message ListTaskListsRequest {
    int64 agent_id = 1;  // Optional filter by agent
}

// ListTaskListsResponse is the response for ListTaskLists.
message ListTaskListsResponse {
    repeated TaskListProto task_lists = 1;
    string error = 2;
}

// UnregisterTaskListRequest is the request for UnregisterTaskList.
message UnregisterTaskListRequest {
    string list_id = 1;
}

// UnregisterTaskListResponse is the response for UnregisterTaskList.
message UnregisterTaskListResponse {
    string error = 1;
}

// UpsertTaskRequest is the request for UpsertTask.
message UpsertTaskRequest {
    int64 agent_id = 1;
    string list_id = 2;
    string claude_task_id = 3;
    string subject = 4;
    string description = 5;
    string active_form = 6;
    string metadata_json = 7;
    TaskStatus status = 8;
    string owner = 9;
    repeated string blocked_by = 10;
    repeated string blocks = 11;
    string file_path = 12;
    int64 file_mtime = 13;
}

// UpsertTaskResponse is the response for UpsertTask.
message UpsertTaskResponse {
    TaskProto task = 1;
    string error = 2;
}

// GetTaskProtoRequest is the request for GetTask.
message GetTaskProtoRequest {
    string list_id = 1;
    string claude_task_id = 2;
}

// GetTaskResponse is the response for GetTask.
message GetTaskResponse {
    TaskProto task = 1;
    string error = 2;
}

// ListTasksRequest is the request for ListTasks.
message ListTasksRequest {
    int64 agent_id = 1;
    string list_id = 2;
    TaskStatus status = 3;
    bool active_only = 4;
    bool available_only = 5;
    int32 limit = 6;
    int32 offset = 7;
}

// ListTasksResponse is the response for ListTasks.
message ListTasksResponse {
    repeated TaskProto tasks = 1;
    string error = 2;
}

// UpdateTaskStatusRequest is the request for UpdateTaskStatus.
message UpdateTaskStatusRequest {
    string list_id = 1;
    string claude_task_id = 2;
    TaskStatus status = 3;
}

// UpdateTaskStatusResponse is the response for UpdateTaskStatus.
message UpdateTaskStatusResponse {
    string error = 1;
}

// UpdateTaskOwnerRequest is the request for UpdateTaskOwner.
message UpdateTaskOwnerRequest {
    string list_id = 1;
    string claude_task_id = 2;
    string owner = 3;
}

// UpdateTaskOwnerResponse is the response for UpdateTaskOwner.
message UpdateTaskOwnerResponse {
    string error = 1;
}

// DeleteTaskRequest is the request for DeleteTask.
message DeleteTaskRequest {
    int64 id = 1;
}

// DeleteTaskResponse is the response for DeleteTask.
message DeleteTaskResponse {
    string error = 1;
}

// GetTaskStatsRequest is the request for GetTaskStats.
message GetTaskStatsRequest {
    int64 agent_id = 1;
    string list_id = 2;
    google.protobuf.Timestamp today_since = 3;
}

// GetTaskStatsResponse is the response for GetTaskStats.
message GetTaskStatsResponse {
    TaskStatsProto stats = 1;
    string error = 2;
}

// GetAllAgentTaskStatsRequest is the request for GetAllAgentTaskStats.
message GetAllAgentTaskStatsRequest {
    google.protobuf.Timestamp today_since = 1;
}

// GetAllAgentTaskStatsResponse is the response for GetAllAgentTaskStats.
message GetAllAgentTaskStatsResponse {
    repeated AgentTaskStatsProto stats = 1;
    string error = 2;
}

// SyncTaskListRequest is the request for SyncTaskList.
message SyncTaskListRequest {
    string list_id = 1;
}

// SyncTaskListResponse is the response for SyncTaskList.
message SyncTaskListResponse {
    int32 tasks_updated = 1;
    int32 tasks_deleted = 2;
    string error = 3;
}

// PruneOldTasksRequest is the request for PruneOldTasks.
message PruneOldTasksRequest {
    google.protobuf.Timestamp older_than = 1;
}

// PruneOldTasksResponse is the response for PruneOldTasks.
message PruneOldTasksResponse {
    string error = 1;
}

// =============================================================================
// PlanReviewService
// =============================================================================

// PlanReviewService handles plan review operations for the plan mode workflow.
service PlanReviewService {
    // CreatePlanReview creates a new plan review record.
    rpc CreatePlanReview (CreatePlanReviewRequest) returns (PlanReviewProto);

    // GetPlanReview retrieves a plan review by its UUID.
    rpc GetPlanReview (GetPlanReviewRequest) returns (PlanReviewProto);

    // GetPlanReviewByThread retrieves the latest plan review for a thread.
    rpc GetPlanReviewByThread (GetPlanReviewByThreadRequest) returns (PlanReviewProto);

    // GetPlanReviewBySession retrieves the pending plan review for a session.
    rpc GetPlanReviewBySession (GetPlanReviewBySessionRequest) returns (PlanReviewProto);

    // ListPlanReviews lists plan reviews with optional filters.
    rpc ListPlanReviews (ListPlanReviewsRequest) returns (ListPlanReviewsResponse);

    // UpdatePlanReviewStatus updates the status of a plan review.
    rpc UpdatePlanReviewStatus (UpdatePlanReviewStatusRequest) returns (PlanReviewProto);

    // DeletePlanReview deletes a plan review by its UUID.
    rpc DeletePlanReview (DeletePlanReviewRequest) returns (DeletePlanReviewResponse);
}

// =============================================================================
// PlanReviewService Messages
// =============================================================================

// PlanReviewState represents the state of a plan review.
enum PlanReviewState {
    PLAN_REVIEW_STATE_UNSPECIFIED = 0;
    PLAN_REVIEW_STATE_PENDING = 1;
    PLAN_REVIEW_STATE_APPROVED = 2;
    PLAN_REVIEW_STATE_REJECTED = 3;
    PLAN_REVIEW_STATE_CHANGES_REQUESTED = 4;
}

// PlanReviewProto represents a plan review record.
message PlanReviewProto {
    int64 id = 1;
    string plan_review_id = 2;
    int64 message_id = 3;
    string thread_id = 4;
    int64 requester_id = 5;
    string reviewer_name = 6;
    string plan_path = 7;
    string plan_title = 8;
    string plan_summary = 9;
    string state = 10;
    string reviewer_comment = 11;
    int64 reviewed_by = 12;
    string session_id = 13;
    int64 created_at = 14;
    int64 updated_at = 15;
    int64 reviewed_at = 16;
    string error = 17;
}

// CreatePlanReviewRequest is the request for CreatePlanReview.
message CreatePlanReviewRequest {
    string plan_review_id = 1;
    int64 message_id = 2;
    string thread_id = 3;
    int64 requester_id = 4;
    string reviewer_name = 5;
    string plan_path = 6;
    string plan_title = 7;
    string plan_summary = 8;
    string session_id = 9;
}

// GetPlanReviewRequest is the request for GetPlanReview.
message GetPlanReviewRequest {
    string plan_review_id = 1;
}

// GetPlanReviewByThreadRequest is the request for GetPlanReviewByThread.
message GetPlanReviewByThreadRequest {
    string thread_id = 1;
}

// GetPlanReviewBySessionRequest is the request for GetPlanReviewBySession.
message GetPlanReviewBySessionRequest {
    string session_id = 1;
}

// ListPlanReviewsRequest is the request for ListPlanReviews.
message ListPlanReviewsRequest {
    string state = 1;
    int64 requester_id = 2;
    int32 limit = 3;
    int32 offset = 4;
}

// ListPlanReviewsResponse is the response for ListPlanReviews.
message ListPlanReviewsResponse {
    repeated PlanReviewProto plan_reviews = 1;
}

// UpdatePlanReviewStatusRequest is the request for UpdatePlanReviewStatus.
message UpdatePlanReviewStatusRequest {
    string plan_review_id = 1;
    string state = 2;
    string reviewer_comment = 3;
    int64 reviewed_by = 4;
}

// DeletePlanReviewRequest is the request for DeletePlanReview.
message DeletePlanReviewRequest {
    string plan_review_id = 1;
}

// DeletePlanReviewResponse is the response for DeletePlanReview.
message DeletePlanReviewResponse {
    string error = 1;
}
