syntax = "proto3";

package subtraterpc;

option go_package = "github.com/roasbeef/subtrate/internal/api/grpc/subtraterpc";

import "google/protobuf/timestamp.proto";

// Mail is the main RPC service for the Subtrate mail system. It provides
// methods for sending, receiving, and managing messages between agents.
service Mail {
    // SendMail sends a new message to one or more recipients.
    rpc SendMail (SendMailRequest) returns (SendMailResponse);

    // FetchInbox retrieves messages from an agent's inbox.
    rpc FetchInbox (FetchInboxRequest) returns (FetchInboxResponse);

    // ReadMessage retrieves a single message by ID and marks it as read.
    rpc ReadMessage (ReadMessageRequest) returns (ReadMessageResponse);

    // ReadThread retrieves all messages in a thread.
    rpc ReadThread (ReadThreadRequest) returns (ReadThreadResponse);

    // UpdateState changes the state of a message (star, snooze, archive, trash).
    rpc UpdateState (UpdateStateRequest) returns (UpdateStateResponse);

    // AckMessage acknowledges receipt of a message with a deadline.
    rpc AckMessage (AckMessageRequest) returns (AckMessageResponse);

    // GetStatus returns the mail status for an agent.
    rpc GetStatus (GetStatusRequest) returns (GetStatusResponse);

    // PollChanges checks for new messages since given offsets.
    rpc PollChanges (PollChangesRequest) returns (PollChangesResponse);

    // SubscribeInbox creates a stream of new inbox messages.
    rpc SubscribeInbox (SubscribeInboxRequest) returns (stream InboxMessage);

    // Publish sends a message to a pub/sub topic.
    rpc Publish (PublishRequest) returns (PublishResponse);

    // Subscribe subscribes an agent to a topic.
    rpc Subscribe (SubscribeRequest) returns (SubscribeResponse);

    // Unsubscribe removes an agent's subscription to a topic.
    rpc Unsubscribe (UnsubscribeRequest) returns (UnsubscribeResponse);

    // ListTopics lists available topics.
    rpc ListTopics (ListTopicsRequest) returns (ListTopicsResponse);

    // Search performs full-text search across messages.
    rpc Search (SearchRequest) returns (SearchResponse);

    // HasUnackedStatusTo checks if there are unacked status messages from
    // sender to recipient. Used for deduplication in status-update command.
    rpc HasUnackedStatusTo (HasUnackedStatusToRequest) returns (HasUnackedStatusToResponse);

    // ReplyToThread sends a reply message to an existing thread.
    rpc ReplyToThread (ReplyToThreadRequest) returns (ReplyToThreadResponse);

    // ArchiveThread archives all messages in a thread.
    rpc ArchiveThread (ArchiveThreadRequest) returns (ArchiveThreadResponse);

    // DeleteThread deletes all messages in a thread.
    rpc DeleteThread (DeleteThreadRequest) returns (DeleteThreadResponse);

    // MarkThreadUnread marks a thread as unread.
    rpc MarkThreadUnread (MarkThreadUnreadRequest) returns (MarkThreadUnreadResponse);

    // GetTopic retrieves a single topic by ID.
    rpc GetTopic (GetTopicRequest) returns (GetTopicResponse);

    // AutocompleteRecipients returns matching agents for autocomplete.
    rpc AutocompleteRecipients (AutocompleteRecipientsRequest) returns (AutocompleteRecipientsResponse);

    // DeleteMessage marks a message as deleted/trash.
    rpc DeleteMessage (DeleteMessageRequest) returns (DeleteMessageResponse);
}

// Agent is the RPC service for managing agent identities.
service Agent {
    // RegisterAgent creates a new agent with the given name.
    rpc RegisterAgent (RegisterAgentRequest) returns (RegisterAgentResponse);

    // GetAgent retrieves an agent by ID or name.
    rpc GetAgent (GetAgentRequest) returns (GetAgentResponse);

    // ListAgents lists all registered agents.
    rpc ListAgents (ListAgentsRequest) returns (ListAgentsResponse);

    // DeleteAgent removes an agent by ID.
    rpc DeleteAgent (DeleteAgentRequest) returns (DeleteAgentResponse);

    // UpdateAgent updates an agent's properties.
    rpc UpdateAgent (UpdateAgentRequest) returns (UpdateAgentResponse);

    // GetAgentsStatus returns all agents with their status and counts.
    rpc GetAgentsStatus (GetAgentsStatusRequest) returns (GetAgentsStatusResponse);

    // Heartbeat records a heartbeat for an agent.
    rpc Heartbeat (HeartbeatRequest) returns (HeartbeatResponse);

    // EnsureIdentity creates or retrieves an agent identity for a session.
    rpc EnsureIdentity (EnsureIdentityRequest) returns (EnsureIdentityResponse);

    // SaveIdentity persists an agent's current state.
    rpc SaveIdentity (SaveIdentityRequest) returns (SaveIdentityResponse);
}

// Session is the RPC service for managing agent sessions.
service Session {
    // ListSessions lists all sessions with optional filters.
    rpc ListSessions (ListSessionsRequest) returns (ListSessionsResponse);

    // GetSession retrieves a single session by ID.
    rpc GetSession (GetSessionRequest) returns (GetSessionResponse);

    // StartSession starts a new session for an agent.
    rpc StartSession (StartSessionRequest) returns (StartSessionResponse);

    // CompleteSession marks a session as completed.
    rpc CompleteSession (CompleteSessionRequest) returns (CompleteSessionResponse);
}

// Activity is the RPC service for activity feeds.
service Activity {
    // ListActivities lists activities with optional filters.
    rpc ListActivities (ListActivitiesRequest) returns (ListActivitiesResponse);
}

// Stats is the RPC service for dashboard statistics.
service Stats {
    // GetDashboardStats returns dashboard statistics.
    rpc GetDashboardStats (GetDashboardStatsRequest) returns (GetDashboardStatsResponse);

    // HealthCheck returns server health status.
    rpc HealthCheck (HealthCheckRequest) returns (HealthCheckResponse);
}

// Priority represents message priority levels.
enum Priority {
    PRIORITY_UNSPECIFIED = 0;
    PRIORITY_LOW = 1;
    PRIORITY_NORMAL = 2;
    PRIORITY_URGENT = 3;
}

// MessageState represents the state of a message for a recipient.
enum MessageState {
    STATE_UNSPECIFIED = 0;
    STATE_UNREAD = 1;
    STATE_READ = 2;
    STATE_STARRED = 3;
    STATE_SNOOZED = 4;
    STATE_ARCHIVED = 5;
    STATE_TRASH = 6;
}

// InboxMessage represents a message in an agent's inbox.
// Note: int64 fields serialize as strings in JSON (protobuf standard).
// Timestamps use RFC 3339 format. Priority/state serialize as enum strings.
message InboxMessage {
    int64 id = 1;
    string thread_id = 2;
    int64 topic_id = 3;
    int64 sender_id = 4;
    string sender_name = 5;
    string sender_project_key = 15;  // Agent's project key (e.g., "substrate").
    string sender_git_branch = 16;   // Agent's git branch (e.g., "main").
    string subject = 6;
    string body = 7;
    Priority priority = 8;
    MessageState state = 9;
    google.protobuf.Timestamp created_at = 10;
    google.protobuf.Timestamp deadline_at = 11;      // null if no deadline
    google.protobuf.Timestamp snoozed_until = 12;    // null if not snoozed
    google.protobuf.Timestamp read_at = 13;          // null if unread
    google.protobuf.Timestamp acknowledged_at = 14;  // null if not acked
}

// SendMailRequest is the request for SendMail.
message SendMailRequest {
    int64 sender_id = 1;
    repeated string recipient_names = 2;
    string topic_name = 3;          // For pub/sub, mutually exclusive with recipients
    string thread_id = 4;           // Optional, for replies
    string subject = 5;
    string body = 6;
    Priority priority = 7;
    google.protobuf.Timestamp deadline_at = 8;  // Optional deadline
    string attachments_json = 9;    // JSON string of attachments
}

// SendMailResponse is the response for SendMail.
message SendMailResponse {
    int64 message_id = 1;
    string thread_id = 2;
}

// FetchInboxRequest is the request for FetchInbox.
message FetchInboxRequest {
    int64 agent_id = 1;
    int32 limit = 2;            // Maximum messages to return
    bool unread_only = 3;       // Only return unread messages
    MessageState state_filter = 4;  // Filter by state
    bool sent_only = 5;         // Only return messages sent by the agent
}

// FetchInboxResponse is the response for FetchInbox.
message FetchInboxResponse {
    repeated InboxMessage messages = 1;
}

// ReadMessageRequest is the request for ReadMessage.
message ReadMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
}

// ReadMessageResponse is the response for ReadMessage.
message ReadMessageResponse {
    InboxMessage message = 1;
}

// ReadThreadRequest is the request for ReadThread.
message ReadThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// ReadThreadResponse is the response for ReadThread.
message ReadThreadResponse {
    repeated InboxMessage messages = 1;
}

// UpdateStateRequest is the request for UpdateState.
message UpdateStateRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
    MessageState new_state = 3;
    google.protobuf.Timestamp snoozed_until = 4;    // Required for STATE_SNOOZED
}

// UpdateStateResponse is the response for UpdateState.
message UpdateStateResponse {
    bool success = 1;
}

// AckMessageRequest is the request for AckMessage.
message AckMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
}

// AckMessageResponse is the response for AckMessage.
message AckMessageResponse {
    bool success = 1;
}

// GetStatusRequest is the request for GetStatus.
message GetStatusRequest {
    int64 agent_id = 1;
}

// GetStatusResponse is the response for GetStatus.
message GetStatusResponse {
    int64 agent_id = 1;
    string agent_name = 2;
    int64 unread_count = 3;
    int64 urgent_count = 4;
    int64 starred_count = 5;
    int64 snoozed_count = 6;
}

// PollChangesRequest is the request for PollChanges.
message PollChangesRequest {
    int64 agent_id = 1;
    map<int64, int64> since_offsets = 2;    // topic_id -> last_offset
}

// PollChangesResponse is the response for PollChanges.
message PollChangesResponse {
    repeated InboxMessage new_messages = 1;
    map<int64, int64> new_offsets = 2;      // topic_id -> new_offset
}

// SubscribeInboxRequest is the request for SubscribeInbox streaming.
message SubscribeInboxRequest {
    int64 agent_id = 1;
}

// PublishRequest is the request for Publish.
message PublishRequest {
    int64 sender_id = 1;
    string topic_name = 2;
    string subject = 3;
    string body = 4;
    Priority priority = 5;
}

// PublishResponse is the response for Publish.
message PublishResponse {
    int64 message_id = 1;
    int32 recipients_count = 2;
}

// SubscribeRequest is the request for Subscribe.
message SubscribeRequest {
    int64 agent_id = 1;
    string topic_name = 2;
}

// SubscribeResponse is the response for Subscribe.
message SubscribeResponse {
    bool success = 1;
    int64 topic_id = 2;
}

// UnsubscribeRequest is the request for Unsubscribe.
message UnsubscribeRequest {
    int64 agent_id = 1;
    string topic_name = 2;
}

// UnsubscribeResponse is the response for Unsubscribe.
message UnsubscribeResponse {
    bool success = 1;
}

// Topic represents a pub/sub topic.
message Topic {
    int64 id = 1;
    string name = 2;
    string topic_type = 3;      // "direct", "broadcast", "queue"
    google.protobuf.Timestamp created_at = 4;
    int64 message_count = 5;    // Number of messages in this topic
}

// ListTopicsRequest is the request for ListTopics.
message ListTopicsRequest {
    int64 agent_id = 1;         // If set, only show subscribed topics
    bool subscribed_only = 2;
}

// ListTopicsResponse is the response for ListTopics.
message ListTopicsResponse {
    repeated Topic topics = 1;
}

// SearchRequest is the request for Search.
message SearchRequest {
    int64 agent_id = 1;
    string query = 2;
    int64 topic_id = 3;         // Optional, filter by topic
    int32 limit = 4;
}

// SearchResponse is the response for Search.
message SearchResponse {
    repeated InboxMessage results = 1;
}

// HasUnackedStatusToRequest is the request for HasUnackedStatusTo.
message HasUnackedStatusToRequest {
    int64 sender_id = 1;
    int64 recipient_id = 2;
}

// HasUnackedStatusToResponse is the response for HasUnackedStatusTo.
message HasUnackedStatusToResponse {
    bool has_pending = 1;
}

// RegisterAgentRequest is the request for RegisterAgent.
message RegisterAgentRequest {
    string name = 1;
    string project_key = 2;     // Optional project binding
}

// RegisterAgentResponse is the response for RegisterAgent.
message RegisterAgentResponse {
    int64 agent_id = 1;
    string name = 2;
}

// GetAgentRequest is the request for GetAgent.
message GetAgentRequest {
    int64 agent_id = 1;         // Use ID or name
    string name = 2;
}

// GetAgentResponse is the response for GetAgent.
// Note: int64 fields serialize as strings in JSON (protobuf standard).
message GetAgentResponse {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string session_id = 4;  // Current session ID (renamed from current_session_id)
    google.protobuf.Timestamp created_at = 5;
    google.protobuf.Timestamp last_active_at = 6;
}

// ListAgentsRequest is the request for ListAgents.
message ListAgentsRequest {
    int32 limit = 1;
}

// ListAgentsResponse is the response for ListAgents.
message ListAgentsResponse {
    repeated GetAgentResponse agents = 1;
}

// EnsureIdentityRequest is the request for EnsureIdentity.
message EnsureIdentityRequest {
    string session_id = 1;
    string project_dir = 2;
    string git_branch = 3;
}

// EnsureIdentityResponse is the response for EnsureIdentity.
message EnsureIdentityResponse {
    int64 agent_id = 1;
    string agent_name = 2;
    bool created = 3;           // True if a new agent was created
}

// SaveIdentityRequest is the request for SaveIdentity.
message SaveIdentityRequest {
    string session_id = 1;
    int64 agent_id = 2;
    map<int64, int64> consumer_offsets = 3;     // topic_id -> offset
}

// SaveIdentityResponse is the response for SaveIdentity.
message SaveIdentityResponse {
    bool success = 1;
}

// DeleteAgentRequest is the request for DeleteAgent.
message DeleteAgentRequest {
    int64 id = 1;
}

// DeleteAgentResponse is the response for DeleteAgent.
message DeleteAgentResponse {
    bool success = 1;
}

// =============================================================================
// New Message Types for Extended API
// =============================================================================

// ReplyToThreadRequest is the request for ReplyToThread.
message ReplyToThreadRequest {
    int64 sender_id = 1;
    string thread_id = 2;
    string body = 3;
}

// ReplyToThreadResponse is the response for ReplyToThread.
message ReplyToThreadResponse {
    int64 message_id = 1;
}

// ArchiveThreadRequest is the request for ArchiveThread.
message ArchiveThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// ArchiveThreadResponse is the response for ArchiveThread.
message ArchiveThreadResponse {
    bool success = 1;
    int32 messages_archived = 2;
}

// DeleteThreadRequest is the request for DeleteThread.
message DeleteThreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// DeleteThreadResponse is the response for DeleteThread.
message DeleteThreadResponse {
    bool success = 1;
    int32 messages_deleted = 2;
}

// MarkThreadUnreadRequest is the request for MarkThreadUnread.
message MarkThreadUnreadRequest {
    int64 agent_id = 1;
    string thread_id = 2;
}

// MarkThreadUnreadResponse is the response for MarkThreadUnread.
message MarkThreadUnreadResponse {
    bool success = 1;
}

// GetTopicRequest is the request for GetTopic.
message GetTopicRequest {
    int64 topic_id = 1;
}

// GetTopicResponse is the response for GetTopic.
message GetTopicResponse {
    Topic topic = 1;
}

// AutocompleteRecipientsRequest is the request for AutocompleteRecipients.
message AutocompleteRecipientsRequest {
    string query = 1;
    int32 limit = 2;
}

// AutocompleteRecipient represents a recipient suggestion.
message AutocompleteRecipient {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string git_branch = 4;
    string status = 5;  // "active", "busy", "idle", "offline"
}

// AutocompleteRecipientsResponse is the response for AutocompleteRecipients.
message AutocompleteRecipientsResponse {
    repeated AutocompleteRecipient recipients = 1;
}

// DeleteMessageRequest is the request for DeleteMessage.
message DeleteMessageRequest {
    int64 agent_id = 1;
    int64 message_id = 2;
}

// DeleteMessageResponse is the response for DeleteMessage.
message DeleteMessageResponse {
    bool success = 1;
}

// UpdateAgentRequest is the request for UpdateAgent.
message UpdateAgentRequest {
    int64 id = 1;
    string project_key = 2;
    string git_branch = 3;
}

// UpdateAgentResponse is the response for UpdateAgent.
message UpdateAgentResponse {
    GetAgentResponse agent = 1;
}

// AgentStatus represents an agent's current status.
enum AgentStatus {
    AGENT_STATUS_UNSPECIFIED = 0;
    AGENT_STATUS_ACTIVE = 1;
    AGENT_STATUS_BUSY = 2;
    AGENT_STATUS_IDLE = 3;
    AGENT_STATUS_OFFLINE = 4;
}

// AgentWithStatus represents an agent with its current status.
message AgentWithStatus {
    int64 id = 1;
    string name = 2;
    string project_key = 3;
    string git_branch = 4;
    AgentStatus status = 5;
    google.protobuf.Timestamp last_active_at = 6;
    int64 session_id = 7;
    int64 seconds_since_heartbeat = 8;
}

// AgentStatusCounts represents counts of agents by status.
message AgentStatusCounts {
    int32 active = 1;
    int32 busy = 2;
    int32 idle = 3;
    int32 offline = 4;
}

// GetAgentsStatusRequest is the request for GetAgentsStatus.
message GetAgentsStatusRequest {}

// GetAgentsStatusResponse is the response for GetAgentsStatus.
message GetAgentsStatusResponse {
    repeated AgentWithStatus agents = 1;
    AgentStatusCounts counts = 2;
}

// HeartbeatRequest is the request for Heartbeat.
// Either agent_id or agent_name must be provided. If both are given,
// agent_id takes precedence.
message HeartbeatRequest {
    int64 agent_id = 1 [json_name = "agent_id"];
    string session_id = 2 [json_name = "session_id"];
    string agent_name = 3 [json_name = "agent_name"];
}

// HeartbeatResponse is the response for Heartbeat.
message HeartbeatResponse {
    bool success = 1;
}

// =============================================================================
// Session Service Messages
// =============================================================================

// SessionStatus represents the status of a session.
enum SessionStatus {
    SESSION_STATUS_UNSPECIFIED = 0;
    SESSION_STATUS_ACTIVE = 1;
    SESSION_STATUS_COMPLETED = 2;
    SESSION_STATUS_ABANDONED = 3;
}

// SessionInfo represents a session.
message SessionInfo {
    int64 id = 1;
    int64 agent_id = 2;
    string agent_name = 3;
    string project = 4;
    string branch = 5;
    google.protobuf.Timestamp started_at = 6;
    google.protobuf.Timestamp ended_at = 7;
    SessionStatus status = 8;
}

// ListSessionsRequest is the request for ListSessions.
message ListSessionsRequest {
    bool active_only = 1;
    int32 limit = 2;
}

// ListSessionsResponse is the response for ListSessions.
message ListSessionsResponse {
    repeated SessionInfo sessions = 1;
}

// GetSessionRequest is the request for GetSession.
message GetSessionRequest {
    int64 session_id = 1;
}

// GetSessionResponse is the response for GetSession.
message GetSessionResponse {
    SessionInfo session = 1;
}

// StartSessionRequest is the request for StartSession.
message StartSessionRequest {
    int64 agent_id = 1;
    string project = 2;
    string branch = 3;
}

// StartSessionResponse is the response for StartSession.
message StartSessionResponse {
    SessionInfo session = 1;
}

// CompleteSessionRequest is the request for CompleteSession.
message CompleteSessionRequest {
    int64 session_id = 1;
}

// CompleteSessionResponse is the response for CompleteSession.
message CompleteSessionResponse {
    bool success = 1;
}

// =============================================================================
// Activity Service Messages
// =============================================================================

// ActivityType represents the type of an activity.
enum ActivityType {
    ACTIVITY_TYPE_UNSPECIFIED = 0;
    ACTIVITY_TYPE_MESSAGE_SENT = 1;
    ACTIVITY_TYPE_MESSAGE_READ = 2;
    ACTIVITY_TYPE_SESSION_STARTED = 3;
    ACTIVITY_TYPE_SESSION_COMPLETED = 4;
    ACTIVITY_TYPE_AGENT_REGISTERED = 5;
    ACTIVITY_TYPE_HEARTBEAT = 6;
}

// ActivityInfo represents an activity entry.
message ActivityInfo {
    int64 id = 1;
    int64 agent_id = 2;
    string agent_name = 3;
    ActivityType type = 4;
    string description = 5;
    google.protobuf.Timestamp created_at = 6;
    string metadata_json = 7;  // JSON-encoded metadata
}

// ListActivitiesRequest is the request for ListActivities.
message ListActivitiesRequest {
    int64 agent_id = 1;         // Filter by agent (0 = all)
    ActivityType type = 2;      // Filter by type (UNSPECIFIED = all)
    int32 page = 3;
    int32 page_size = 4;
}

// ListActivitiesResponse is the response for ListActivities.
message ListActivitiesResponse {
    repeated ActivityInfo activities = 1;
    int64 total = 2;
    int32 page = 3;
    int32 page_size = 4;
}

// =============================================================================
// Stats Service Messages
// =============================================================================

// DashboardStats represents dashboard statistics.
message DashboardStats {
    int32 active_agents = 1;
    int32 running_sessions = 2;
    int32 pending_messages = 3;
    int32 completed_today = 4;
}

// GetDashboardStatsRequest is the request for GetDashboardStats.
message GetDashboardStatsRequest {}

// GetDashboardStatsResponse is the response for GetDashboardStats.
message GetDashboardStatsResponse {
    DashboardStats stats = 1;
}

// HealthCheckRequest is the request for HealthCheck.
message HealthCheckRequest {}

// HealthCheckResponse is the response for HealthCheck.
message HealthCheckResponse {
    string status = 1;  // "ok" or "error"
    google.protobuf.Timestamp time = 2;
}
